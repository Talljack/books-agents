# BookFinder AI - é¡¹ç›®æ¶æ„æ–‡æ¡£

> æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº† BookFinder AI é¡¹ç›®çš„æ•´ä½“æ¶æ„ã€æŠ€æœ¯å®ç°å’Œå…³é”®æµç¨‹ï¼Œå¯ä½œä¸ºåç»­å¼€å‘å’Œç»´æŠ¤çš„ä¸Šä¸‹æ–‡å‚è€ƒã€‚

## ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
2. [æŠ€æœ¯æ ˆ](#2-æŠ€æœ¯æ ˆ)
3. [ç³»ç»Ÿæ¶æ„å›¾](#3-ç³»ç»Ÿæ¶æ„å›¾)
4. [ç›®å½•ç»“æ„](#4-ç›®å½•ç»“æ„)
5. [LangGraph Agent è¯¦è§£](#5-langgraph-agent-è¯¦è§£)
6. [æ•°æ®æµæ¶æ„](#6-æ•°æ®æµæ¶æ„)
7. [API è·¯ç”±](#7-api-è·¯ç”±)
8. [ç»„ä»¶æ¶æ„](#8-ç»„ä»¶æ¶æ„)
9. [æ•°æ®æºé›†æˆ](#9-æ•°æ®æºé›†æˆ)
10. [LLM å¤šæä¾›å•†æ”¯æŒ](#10-llm-å¤šæä¾›å•†æ”¯æŒ)
11. [æ ¸å¿ƒç±»å‹å®šä¹‰](#11-æ ¸å¿ƒç±»å‹å®šä¹‰)

---

## 1. é¡¹ç›®æ¦‚è¿°

BookFinder AI æ˜¯ä¸€ä¸ª AI é©±åŠ¨çš„æ™ºèƒ½å›¾ä¹¦å‘ç°å¹³å°ï¼Œä½¿ç”¨è‡ªç„¶è¯­è¨€å¯¹è¯å¸®åŠ©ç”¨æˆ·æ‰¾åˆ°æœ€åˆé€‚çš„ä¹¦ç±ã€‚

### æ ¸å¿ƒç‰¹æ€§

- **å¯¹è¯å¼äº¤äº’**ï¼šç”¨æˆ·ç”¨è‡ªç„¶è¯­è¨€æè¿°éœ€æ±‚ï¼ŒAI ç†è§£å¹¶æ¨èä¹¦ç±
- **å¤šæºèšåˆæœç´¢**ï¼šæ•´åˆ Google Booksã€Open Libraryã€è±†ç“£ã€Internet Archive å››å¤§æ•°æ®æº
- **LangGraph æ™ºèƒ½ Agent**ï¼šåŸºäºçŠ¶æ€å›¾çš„ AI Agentï¼Œæ”¯æŒå¤šè½®å¯¹è¯å’Œæ„å›¾ç†è§£
- **å¤š LLM æ”¯æŒ**ï¼šæ”¯æŒ 18+ AI æ¨¡å‹æä¾›å•†ï¼ŒåŒ…æ‹¬æœ¬åœ° Ollama
- **ä¸¤é˜¶æ®µæœç´¢æµç¨‹**ï¼šå…ˆåˆ†ææ„å›¾è®©ç”¨æˆ·ç¡®è®¤ï¼Œå†æ‰§è¡Œæœç´¢

---

## 2. æŠ€æœ¯æ ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æŠ€æœ¯æ ˆå…¨æ™¯                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  å‰ç«¯ (Frontend)                                                 â”‚
â”‚  â”œâ”€â”€ Next.js 15 (App Router + Turbopack)                        â”‚
â”‚  â”œâ”€â”€ React 19                                                    â”‚
â”‚  â”œâ”€â”€ TypeScript 5.9                                              â”‚
â”‚  â”œâ”€â”€ Tailwind CSS 3.4                                            â”‚
â”‚  â”œâ”€â”€ Framer Motion (åŠ¨ç”»)                                        â”‚
â”‚  â”œâ”€â”€ shadcn/ui + Radix UI (ç»„ä»¶åº“)                               â”‚
â”‚  â””â”€â”€ react-hot-toast (é€šçŸ¥)                                      â”‚
â”‚                                                                  â”‚
â”‚  AI/LLM                                                          â”‚
â”‚  â”œâ”€â”€ LangChain Core 1.1                                          â”‚
â”‚  â”œâ”€â”€ LangGraph 1.0 (çŠ¶æ€æœº/Agent)                                â”‚
â”‚  â”œâ”€â”€ @langchain/openai (OpenAI/OpenRouter)                       â”‚
â”‚  â”œâ”€â”€ @langchain/anthropic (Claude)                               â”‚
â”‚  â”œâ”€â”€ @langchain/ollama (æœ¬åœ°æ¨¡å‹)                                â”‚
â”‚  â””â”€â”€ Zod (Schema éªŒè¯)                                           â”‚
â”‚                                                                  â”‚
â”‚  æ•°æ®æº API                                                       â”‚
â”‚  â”œâ”€â”€ Google Books API                                            â”‚
â”‚  â”œâ”€â”€ Open Library API                                            â”‚
â”‚  â”œâ”€â”€ è±†ç“£ Rexxar API (ç§»åŠ¨ç«¯)                                     â”‚
â”‚  â””â”€â”€ Internet Archive API                                        â”‚
â”‚                                                                  â”‚
â”‚  å¼€å‘å·¥å…·                                                         â”‚
â”‚  â”œâ”€â”€ pnpm (åŒ…ç®¡ç†)                                               â”‚
â”‚  â”œâ”€â”€ ESLint + Prettier                                           â”‚
â”‚  â”œâ”€â”€ simple-git-hooks + lint-staged                              â”‚
â”‚  â””â”€â”€ TypeScript (ä¸¥æ ¼æ¨¡å¼)                                        â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ç³»ç»Ÿæ¶æ„å›¾

### 3.1 æ•´ä½“ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ç”¨æˆ·æµè§ˆå™¨                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Next.js 15 åº”ç”¨                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                         å‰ç«¯å±‚ (Client)                                 â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚ â”‚
â”‚  â”‚  â”‚   é¦–é¡µ       â”‚  â”‚   æœç´¢é¡µ     â”‚  â”‚   è¯¦æƒ…é¡µ     â”‚                 â”‚ â”‚
â”‚  â”‚  â”‚  page.tsx    â”‚  â”‚search/page   â”‚  â”‚book/[id]/pageâ”‚                 â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚ â”‚
â”‚  â”‚                           â”‚                                            â”‚ â”‚
â”‚  â”‚                           â–¼                                            â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚                    ç»„ä»¶å±‚ (Components)                           â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  ChatInterface | BookCard | IntentConfirmation | PreferenceChips â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                           â”‚                                            â”‚ â”‚
â”‚  â”‚                           â–¼                                            â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚                    Hooks å±‚                                      â”‚  â”‚ â”‚
â”‚  â”‚  â”‚        useChatStream | useBookSearch | useAIAnalysis            â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                         API è·¯ç”±å±‚ (Server)                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚ â”‚
â”‚  â”‚  â”‚/api/chat   â”‚ â”‚/api/search â”‚ â”‚/api/analyzeâ”‚ â”‚/api/analyze-   â”‚      â”‚ â”‚
â”‚  â”‚  â”‚            â”‚ â”‚            â”‚ â”‚            â”‚ â”‚    intent      â”‚      â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ â”‚
â”‚  â”‚        â”‚              â”‚              â”‚                 â”‚               â”‚ â”‚
â”‚  â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚ â”‚
â”‚  â”‚                       â”‚              â”‚                                 â”‚ â”‚
â”‚  â”‚                       â–¼              â–¼                                 â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚                    LangGraph Agent å±‚                            â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                                  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚   â”‚                 BookAgentGraph                          â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚   â”‚  START â†’ conversation â†’ tools â†’ respond â†’ END           â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                                  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚   â”‚              BookSearchAgent (ç®€åŒ–ç‰ˆ)                    â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚   â”‚  START â†’ search/analyze â†’ END                           â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                       â”‚                                               â”‚ â”‚
â”‚  â”‚                       â–¼                                               â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚                    æœåŠ¡å±‚                                        â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  LLM Factory â”‚  â”‚  Book APIs   â”‚  â”‚  Prompts & Tools     â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚              â”‚  â”‚              â”‚  â”‚                      â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ 18+ Providersâ”‚  â”‚ 4 æ•°æ®æº     â”‚  â”‚ æ„å›¾åˆ†æ/æœç´¢/å“åº”   â”‚   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                         â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   LLM æä¾›å•†     â”‚     â”‚   ä¹¦ç±æ•°æ®æº    â”‚     â”‚   æœ¬åœ°æœåŠ¡       â”‚
â”‚                 â”‚     â”‚                 â”‚     â”‚                 â”‚
â”‚ â€¢ OpenAI        â”‚     â”‚ â€¢ Google Books  â”‚     â”‚ â€¢ Ollama        â”‚
â”‚ â€¢ Anthropic     â”‚     â”‚ â€¢ Open Library  â”‚     â”‚   (localhost)   â”‚
â”‚ â€¢ DeepSeek      â”‚     â”‚ â€¢ è±†ç“£          â”‚     â”‚                 â”‚
â”‚ â€¢ OpenRouter    â”‚     â”‚ â€¢ IA Archive    â”‚     â”‚                 â”‚
â”‚ â€¢ Moonshot      â”‚     â”‚                 â”‚     â”‚                 â”‚
â”‚ â€¢ æ™ºè°±AI        â”‚     â”‚                 â”‚     â”‚                 â”‚
â”‚ â€¢ ...18+        â”‚     â”‚                 â”‚     â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 è¯·æ±‚å¤„ç†æµç¨‹

```
ç”¨æˆ·è¾“å…¥ "æ¨èæœºå™¨å­¦ä¹ å…¥é—¨ä¹¦ç±"
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ChatInterface ç»„ä»¶                                â”‚
â”‚  â€¢ æ£€æµ‹è¯­è¨€ (ä¸­æ–‡)                                                       â”‚
â”‚  â€¢ è°ƒç”¨ useChatStream.analyzeIntent()                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      POST /api/analyze-intent                           â”‚
â”‚  â€¢ è°ƒç”¨ inferPreferencesWithLLM()                                       â”‚
â”‚  â€¢ è¿”å›æ¨æ–­çš„åå¥½å’Œç†è§£æ–‡æœ¬                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    IntentConfirmation ç»„ä»¶                              â”‚
â”‚  â€¢ æ˜¾ç¤º AI å¯¹éœ€æ±‚çš„ç†è§£                                                  â”‚
â”‚  â€¢ ç”¨æˆ·å¯è°ƒæ•´: ä¸»é¢˜ã€éš¾åº¦ã€è¯­è¨€ã€ä¹¦ç±ç±»å‹                                 â”‚
â”‚  â€¢ ç”¨æˆ·ç‚¹å‡» "ç¡®è®¤æœç´¢"                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      POST /api/confirm-search                           â”‚
â”‚  â€¢ æ„å»ºæœç´¢æŸ¥è¯¢                                                          â”‚
â”‚  â€¢ è°ƒç”¨ searchBooksTool (å¤šæ•°æ®æºå¹¶è¡Œæœç´¢)                               â”‚
â”‚  â€¢ ç›¸å…³æ€§è¯„åˆ†æ’åº                                                        â”‚
â”‚  â€¢ LLM ç”Ÿæˆæ¨èè¯´æ˜                                                      â”‚
â”‚  â€¢ è¿”å›ä¹¦ç±åˆ—è¡¨                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ˜¾ç¤ºæœç´¢ç»“æœ                                       â”‚
â”‚  â€¢ BookCard ç½‘æ ¼å±•ç¤º                                                     â”‚
â”‚  â€¢ PreferenceChips æ”¯æŒè°ƒæ•´åé‡æ–°æœç´¢                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. ç›®å½•ç»“æ„

```
books-agents/
â”œâ”€â”€ docs/                           # æ–‡æ¡£ç›®å½•
â”‚   â”œâ”€â”€ LANGGRAPH_GUIDE.md         # LangGraph æŠ€æœ¯æŒ‡å—
â”‚   â”œâ”€â”€ LANGGRAPH_DIAGRAMS.md      # LangGraph å›¾è¡¨
â”‚   â””â”€â”€ PROJECT_ARCHITECTURE.md    # æœ¬æ–‡æ¡£
â”‚
â”œâ”€â”€ public/                         # é™æ€èµ„æº
â”‚   â””â”€â”€ book-placeholder.svg       # ä¹¦ç±å ä½å›¾
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/                        # Next.js App Router
â”‚   â”‚   â”œâ”€â”€ api/                   # API è·¯ç”±
â”‚   â”‚   â”‚   â”œâ”€â”€ analyze/           # ä¹¦ç±åˆ†æ API
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ route.ts       # POST: åˆ†æå•æœ¬ä¹¦ç±
â”‚   â”‚   â”‚   â”œâ”€â”€ analyze-intent/    # æ„å›¾åˆ†æ API
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ route.ts       # POST: åˆ†æç”¨æˆ·æœç´¢æ„å›¾
â”‚   â”‚   â”‚   â”œâ”€â”€ chat/              # èŠå¤© API
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ route.ts       # POST: ç»Ÿä¸€å¯¹è¯æ¥å£ (basic/agent æ¨¡å¼)
â”‚   â”‚   â”‚   â”œâ”€â”€ confirm-search/    # ç¡®è®¤æœç´¢ API
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ route.ts       # POST: æ‰§è¡Œç¡®è®¤åçš„æœç´¢
â”‚   â”‚   â”‚   â”œâ”€â”€ model-config/      # æ¨¡å‹é…ç½® API
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ route.ts       # GET: è·å–å½“å‰é…ç½®
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ models/route.ts # GET: è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ update/route.ts # POST: æ›´æ–°æ¨¡å‹é…ç½®
â”‚   â”‚   â”‚   â”œâ”€â”€ recommend/         # æ¨è API
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ route.ts       # POST: åŸºäºä¹¦ç±/åå¥½æ¨è
â”‚   â”‚   â”‚   â””â”€â”€ search/            # æœç´¢ API
â”‚   â”‚   â”‚       â””â”€â”€ route.ts       # POST: ç›´æ¥æœç´¢ä¹¦ç±
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ book/[id]/             # ä¹¦ç±è¯¦æƒ…é¡µ
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx           # åŠ¨æ€è·¯ç”±é¡µé¢
â”‚   â”‚   â”œâ”€â”€ search/                # æœç´¢é¡µ
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx           # ä¸‰æ¨¡å¼æœç´¢ç•Œé¢
â”‚   â”‚   â”œâ”€â”€ settings/              # è®¾ç½®é¡µ
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx           # LLM é…ç½®ç•Œé¢
â”‚   â”‚   â”œâ”€â”€ globals.css            # å…¨å±€æ ·å¼
â”‚   â”‚   â”œâ”€â”€ layout.tsx             # æ ¹å¸ƒå±€
â”‚   â”‚   â””â”€â”€ page.tsx               # é¦–é¡µ (Landing)
â”‚   â”‚
â”‚   â”œâ”€â”€ components/                 # React ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ blocks/                # é¡µé¢åŒºå—ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ footer.tsx         # é¡µè„š
â”‚   â”‚   â”‚   â”œâ”€â”€ header.tsx         # é¡µå¤´
â”‚   â”‚   â”‚   â”œâ”€â”€ hero.tsx           # é¦–é¡µ Hero åŒºåŸŸ
â”‚   â”‚   â”‚   â””â”€â”€ search-box.tsx     # æœç´¢æ¡†ç»„ä»¶
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ book/                  # ä¹¦ç±ç›¸å…³ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ ai-analysis.tsx    # AI åˆ†æç»“æœå±•ç¤º
â”‚   â”‚   â”‚   â”œâ”€â”€ book-card.tsx      # ä¹¦ç±å¡ç‰‡
â”‚   â”‚   â”‚   â””â”€â”€ book-skeleton.tsx  # åŠ è½½éª¨æ¶å±
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ chat/                  # èŠå¤©ç›¸å…³ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ chat-interface.tsx # æ ¸å¿ƒèŠå¤©ç•Œé¢
â”‚   â”‚   â”‚   â”œâ”€â”€ intent-confirmation.tsx # æ„å›¾ç¡®è®¤å¡ç‰‡
â”‚   â”‚   â”‚   â””â”€â”€ preference-chips.tsx    # åå¥½è°ƒæ•´æ ‡ç­¾
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ settings/              # è®¾ç½®ç›¸å…³ç»„ä»¶
â”‚   â”‚   â”‚   â””â”€â”€ model-settings.tsx # æ¨¡å‹é…ç½®é¢æ¿
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ ui/                    # shadcn/ui åŸºç¡€ç»„ä»¶
â”‚   â”‚       â”œâ”€â”€ badge.tsx
â”‚   â”‚       â”œâ”€â”€ button.tsx
â”‚   â”‚       â”œâ”€â”€ card.tsx
â”‚   â”‚       â”œâ”€â”€ dropdown-menu.tsx
â”‚   â”‚       â”œâ”€â”€ input.tsx
â”‚   â”‚       â”œâ”€â”€ skeleton.tsx
â”‚   â”‚       â””â”€â”€ toaster.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ hooks/                      # React Hooks
â”‚   â”‚   â”œâ”€â”€ use-ai-analysis.ts     # AI åˆ†æ Hook
â”‚   â”‚   â”œâ”€â”€ use-book-search.ts     # ä¹¦ç±æœç´¢ Hook
â”‚   â”‚   â””â”€â”€ use-chat-stream.ts     # èŠå¤©æµ Hook (æ ¸å¿ƒ)
â”‚   â”‚
â”‚   â”œâ”€â”€ lib/                        # æ ¸å¿ƒåº“
â”‚   â”‚   â”œâ”€â”€ agents/                # LangGraph Agent å®ç°
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts           # å¯¼å‡ºå…¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ graph.ts           # ä¸» Agent å›¾å®šä¹‰
â”‚   â”‚   â”‚   â”œâ”€â”€ book-agent.ts      # ç®€åŒ–ç‰ˆæœç´¢/åˆ†æ Agent
â”‚   â”‚   â”‚   â”œâ”€â”€ nodes.ts           # èŠ‚ç‚¹å‡½æ•°å®ç°
â”‚   â”‚   â”‚   â”œâ”€â”€ nodes/             # åˆ†ç¦»çš„èŠ‚ç‚¹æ¨¡å—
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ search.ts      # æœç´¢èŠ‚ç‚¹
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ analyze.ts     # åˆ†æèŠ‚ç‚¹
â”‚   â”‚   â”‚   â”œâ”€â”€ prompts.ts         # æç¤ºè¯æ¨¡æ¿
â”‚   â”‚   â”‚   â”œâ”€â”€ tools.ts           # LangChain Tools å®šä¹‰
â”‚   â”‚   â”‚   â””â”€â”€ types.ts           # çŠ¶æ€ç±»å‹å®šä¹‰
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ api/                   # å¤–éƒ¨ API å®¢æˆ·ç«¯
â”‚   â”‚   â”‚   â”œâ”€â”€ google-books.ts    # Google Books API
â”‚   â”‚   â”‚   â”œâ”€â”€ open-library.ts    # Open Library API
â”‚   â”‚   â”‚   â”œâ”€â”€ douban.ts          # è±†ç“£ API
â”‚   â”‚   â”‚   â””â”€â”€ internet-archive.ts # Internet Archive API
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ llm/                   # LLM å·¥å‚
â”‚   â”‚   â”‚   â””â”€â”€ factory.ts         # å¤šæä¾›å•† LLM åˆ›å»º
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ utils.ts               # é€šç”¨å·¥å…·å‡½æ•°
â”‚   â”‚
â”‚   â”œâ”€â”€ providers/                  # React Context Providers
â”‚   â”‚   â””â”€â”€ theme.tsx              # ä¸»é¢˜ Provider
â”‚   â”‚
â”‚   â””â”€â”€ types/                      # TypeScript ç±»å‹å®šä¹‰
â”‚       â”œâ”€â”€ book.ts                # ä¹¦ç±ç›¸å…³ç±»å‹
â”‚       â””â”€â”€ model-config.ts        # æ¨¡å‹é…ç½®ç±»å‹
â”‚
â”œâ”€â”€ tests/                          # æµ‹è¯•ç›®å½•
â”‚   â”œâ”€â”€ book-search-test.sh        # æœç´¢æµ‹è¯•è„šæœ¬
â”‚   â””â”€â”€ test-results.md            # æµ‹è¯•ç»“æœ
â”‚
â”œâ”€â”€ components.json                 # shadcn/ui é…ç½®
â”œâ”€â”€ env.example                     # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ next.config.ts                  # Next.js é…ç½®
â”œâ”€â”€ package.json                    # ä¾èµ–é…ç½®
â”œâ”€â”€ tailwind.config.ts              # Tailwind é…ç½®
â””â”€â”€ tsconfig.json                   # TypeScript é…ç½®
```

---

## 5. LangGraph Agent è¯¦è§£

### 5.1 Agent æ¶æ„æ¦‚è§ˆ

é¡¹ç›®åŒ…å«ä¸¤ä¸ª LangGraph Agentï¼š

1. **BookAgentGraph** (`graph.ts`) - å®Œæ•´çš„å¯¹è¯å¼æ¨è Agent
2. **BookSearchAgent** (`book-agent.ts`) - ç®€åŒ–çš„æœç´¢/åˆ†æ Agent

### 5.2 BookAgentGraph çŠ¶æ€æœºå›¾

```
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚     START       â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  conversation   â”‚
                              â”‚                 â”‚
                              â”‚ â€¢ LLM åˆ†ææ„å›¾   â”‚
                              â”‚ â€¢ æ¨æ–­ç”¨æˆ·åå¥½   â”‚
                              â”‚ â€¢ æ„å»ºæœç´¢æŸ¥è¯¢   â”‚
                              â”‚ â€¢ ç”Ÿæˆå·¥å…·è°ƒç”¨   â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚              â”‚              â”‚
              has_tool_call    has_error (retry<3)   no_tool_call
                        â”‚              â”‚              â”‚
                        â–¼              â–¼              â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚    tools    â”‚ â”‚conversation â”‚ â”‚    END      â”‚
               â”‚             â”‚ â”‚   (retry)   â”‚ â”‚ (ç­‰å¾…è¾“å…¥)  â”‚
               â”‚ â€¢ æ‰§è¡Œæœç´¢   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ â€¢ è¿”å›ä¹¦ç±   â”‚
               â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                     â”‚
      has_error (retry<3)   no_error
           â”‚                     â”‚
           â–¼                     â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚conversation â”‚       â”‚   respond   â”‚
   â”‚   (retry)   â”‚       â”‚             â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ â€¢ LLM ç”Ÿæˆ   â”‚
                         â”‚   æ¨èè¯´æ˜   â”‚
                         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚    END      â”‚
                         â”‚  (å®Œæˆ)     â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 çŠ¶æ€å®šä¹‰ (BookAgentState)

```typescript
// src/lib/agents/types.ts

export const BookAgentState = Annotation.Root({
  // å¯¹è¯æ¶ˆæ¯å†å² - ç´¯åŠ æ¨¡å¼
  messages: Annotation<BaseMessage[]>({
    reducer: (current, update) => [...current, ...update],
    default: () => [],
  }),

  // ç”¨æˆ·åå¥½ - åˆå¹¶æ¨¡å¼
  preferences: Annotation<UserPreferences>({
    reducer: (current, update) => ({ ...current, ...update }),
    default: () => ({}),
  }),

  // æ¨æ–­çš„åå¥½ï¼ˆç”¨äºå‰ç«¯æ˜¾ç¤ºï¼‰
  inferredPreferences: Annotation<InferredPreferences | undefined>(),

  // æœç´¢ç»“æœä¹¦ç±
  books: Annotation<Book[]>(),

  // æœç´¢æŸ¥è¯¢
  searchQuery: Annotation<string | undefined>(),

  // æ˜¯å¦éœ€è¦æ›´å¤šä¿¡æ¯
  needsMoreInfo: Annotation<boolean>({
    default: () => true,
  }),

  // ç¼ºå¤±çš„ä¿¡æ¯å­—æ®µ
  missingFields: Annotation<string[]>({
    default: () => ["topic", "level"],
  }),

  // å½“å‰é˜¶æ®µ: gathering | searching | presenting | complete
  phase: Annotation<string>({
    default: () => "gathering",
  }),

  // é”™è¯¯ä¿¡æ¯
  error: Annotation<string | undefined>(),

  // é‡è¯•æ¬¡æ•°
  retryCount: Annotation<number>({
    default: () => 0,
  }),
});
```

### 5.4 æ ¸å¿ƒèŠ‚ç‚¹å®ç°

#### conversationNode (å¯¹è¯èŠ‚ç‚¹)

```typescript
// src/lib/agents/nodes.ts

export async function conversationNode(
  state: BookAgentStateType
): Promise<Partial<BookAgentStateType>> {
  // 1. è·å–ç”¨æˆ·æœ€æ–°æ¶ˆæ¯
  const lastMessage = state.messages[state.messages.length - 1];
  const userMessage = typeof lastMessage.content === "string" ? lastMessage.content : "";

  // 2. ä½¿ç”¨ LLM æ™ºèƒ½åˆ†æç”¨æˆ·æ„å›¾
  const inferred = await inferPreferencesWithLLM(userMessage);

  // 3. æ„å»ºæœç´¢æŸ¥è¯¢
  const searchQuery = buildSearchQuery(inferred);

  // 4. åˆ›å»ºå¸¦æœ‰å·¥å…·è°ƒç”¨çš„æ¶ˆæ¯ï¼Œç«‹å³æœç´¢
  const aiMessageWithToolCall = new AIMessage({
    content: `æ­£åœ¨ä¸ºæ‚¨æœç´¢${inferred.levelLabel}çº§åˆ«çš„${inferred.topic}ä¹¦ç±...`,
    tool_calls: [
      {
        id: `search_${Date.now()}`,
        name: "search_books",
        args: { query: searchQuery, maxResults: 10 },
      },
    ],
  });

  return {
    messages: [aiMessageWithToolCall],
    inferredPreferences: inferred,
    preferences: { topic: inferred.topic, level: inferred.level, language: inferred.language },
    needsMoreInfo: false,
    phase: "searching",
    searchQuery,
  };
}
```

#### toolNode (å·¥å…·æ‰§è¡ŒèŠ‚ç‚¹)

```typescript
export async function toolNode(state: BookAgentStateType): Promise<Partial<BookAgentStateType>> {
  const lastMessage = state.messages[state.messages.length - 1] as AIMessage;
  const toolCall = lastMessage.tool_calls?.[0];

  if (toolCall?.name === "search_books") {
    const result = await searchBooksTool.invoke(toolCall.args);
    const books = result as Book[];

    return {
      books,
      searchQuery: toolCall.args.query,
      messages: [
        new ToolMessage({
          tool_call_id: toolCall.id,
          content: JSON.stringify({ success: true, count: books.length }),
        }),
      ],
      phase: "presenting",
    };
  }
  return {};
}
```

#### responseNode (å“åº”ç”ŸæˆèŠ‚ç‚¹)

```typescript
export async function responseNode(
  state: BookAgentStateType
): Promise<Partial<BookAgentStateType>> {
  const llm = createLLM();

  // ç”Ÿæˆæ¨èè¯´æ˜
  const booksInfo = state.books
    .slice(0, 5)
    .map((b, i) => `${i + 1}. "${b.title}" - ${b.authors.join(", ")}`)
    .join("\n");

  const response = await llm.invoke([
    new SystemMessage(RESPONSE_SYSTEM_PROMPTS.zh),
    new HumanMessage(`è¯·ç”¨1-2å¥è¯è¯´æ˜ä¸ºä»€ä¹ˆè¿™äº›ä¹¦é€‚åˆç”¨æˆ·:\n${booksInfo}`),
  ]);

  return {
    messages: [response],
    phase: "complete",
  };
}
```

### 5.5 è·¯ç”±å‡½æ•°

```typescript
// å¯¹è¯èŠ‚ç‚¹åçš„è·¯ç”±
export function routeAfterConversation(state: BookAgentStateType): string {
  // å¦‚æœæœ‰é”™è¯¯ä¸”é‡è¯•æ¬¡æ•°æœªè¶…é™
  if (state.error && state.retryCount < 3) return "conversation";

  // å¦‚æœæœ‰å·¥å…·è°ƒç”¨ï¼Œæ‰§è¡Œå·¥å…·
  const lastMessage = state.messages[state.messages.length - 1];
  if ("tool_calls" in lastMessage && lastMessage.tool_calls?.length > 0) {
    return "tools";
  }

  // å¦åˆ™ç»“æŸ
  return "__end__";
}

// å·¥å…·æ‰§è¡Œåçš„è·¯ç”±
export function routeAfterTools(state: BookAgentStateType): string {
  if (state.error && state.retryCount < 3) return "conversation";
  return "respond";
}
```

### 5.6 æœç´¢å·¥å…·å®šä¹‰

```typescript
// src/lib/agents/tools.ts

export const searchBooksTool = tool(
  async ({ query, maxResults = 20, language }): Promise<Book[]> => {
    // 1. æ ¹æ®è¯­è¨€åå¥½åŠ¨æ€è°ƒæ•´æ•°æ®æºé…æ¯”
    let googleRatio, doubanRatio, openLibraryRatio;

    if (language === "en") {
      googleRatio = 0.7;
      doubanRatio = 0;
      openLibraryRatio = 0.3;
    } else if (language === "zh") {
      googleRatio = 0.4;
      doubanRatio = 0.6;
      openLibraryRatio = 0;
    } else {
      // è‡ªåŠ¨æ£€æµ‹
      googleRatio = queryHasChinese ? 0.4 : 0.6;
      doubanRatio = queryHasChinese ? 0.5 : 0.2;
      openLibraryRatio = queryHasChinese ? 0.1 : 0.2;
    }

    // 2. å¹¶è¡Œæœç´¢å¤šä¸ªæ•°æ®æº
    const [googleResults, doubanResults, openLibraryResults] = await Promise.all([
      searchGoogleBooks(query, filters, googleSearchMax),
      searchDoubanBooks(query, doubanSearchMax),
      searchOpenLibrary(query, openLibrarySearchMax),
    ]);

    // 3. åˆå¹¶å»é‡
    const allBooks = [...googleResults.books, ...doubanResults.books, ...openLibraryResults.books];
    const uniqueBooks = deduplicateBooks(allBooks);

    // 4. ç›¸å…³æ€§è¯„åˆ†
    const scoredBooks = uniqueBooks.map((book) => ({
      book,
      score: calculateRelevanceScore(book, query, keywords, language),
    }));

    // 5. æ’åºè¿”å›
    return scoredBooks
      .filter((item) => item.score > -100)
      .sort((a, b) => b.score - a.score)
      .slice(0, maxResults)
      .map((item) => item.book);
  },
  {
    name: "search_books",
    description: "æœç´¢ä¹¦ç±æ•°æ®åº“ï¼Œæ ¹æ®å…³é”®è¯æŸ¥æ‰¾ç›¸å…³ä¹¦ç±",
    schema: z.object({
      query: z.string().describe("æœç´¢å…³é”®è¯"),
      maxResults: z.number().optional().default(20),
      language: z.enum(["en", "zh", "any"]).optional().default("any"),
    }),
  }
);
```

---

## 6. æ•°æ®æµæ¶æ„

### 6.1 Agent æ¨¡å¼æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Agent æ¨¡å¼æ•°æ®æµ                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·è¾“å…¥: "æ¨è Python å…¥é—¨ä¹¦ç±"
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ChatInterface ç»„ä»¶                                                        â”‚
â”‚    â€¢ è°ƒç”¨ useChatStream.analyzeIntent(message)                              â”‚
â”‚    â€¢ å‘é€ POST /api/analyze-intent                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. /api/analyze-intent                                                       â”‚
â”‚    â€¢ è°ƒç”¨ inferPreferencesWithLLM(message)                                  â”‚
â”‚    â€¢ LLM åˆ†æè¿”å› JSON:                                                      â”‚
â”‚      {                                                                       â”‚
â”‚        topic: "Python",                                                      â”‚
â”‚        category: "technical",                                                â”‚
â”‚        level: "beginner",                                                    â”‚
â”‚        language: "zh",                                                       â”‚
â”‚        searchKeywords: ["Python", "å…¥é—¨", "ç¼–ç¨‹"]                            â”‚
â”‚      }                                                                       â”‚
â”‚    â€¢ ç”Ÿæˆç†è§£æ–‡æœ¬: "æˆ‘ç†è§£æ‚¨æƒ³æ‰¾å…¥é—¨çº§åˆ«çš„ Python ä¸­æ–‡ä¹¦ç±"                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. IntentConfirmation ç»„ä»¶                                                   â”‚
â”‚    æ˜¾ç¤º:                                                                     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚    â”‚ ğŸ¤– æˆ‘ç†è§£æ‚¨æƒ³æ‰¾å…¥é—¨çº§åˆ«çš„ Python ä¸­æ–‡ä¹¦ç±                            â”‚  â”‚
â”‚    â”‚                                                                      â”‚  â”‚
â”‚    â”‚ ä¸»é¢˜: [Python â–¼]  éš¾åº¦: [å…¥é—¨ â–¼]  è¯­è¨€: [ä¸­æ–‡ â–¼]                     â”‚  â”‚
â”‚    â”‚                                                                      â”‚  â”‚
â”‚    â”‚ [å–æ¶ˆ]  [ç¡®è®¤æœç´¢]                                                   â”‚  â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚    â€¢ ç”¨æˆ·å¯è°ƒæ•´ä»»æ„é€‰é¡¹                                                      â”‚
â”‚    â€¢ ç‚¹å‡» "ç¡®è®¤æœç´¢" è§¦å‘ confirmSearch(preferences)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. /api/confirm-search                                                       â”‚
â”‚    â€¢ æ„å»ºæœç´¢æŸ¥è¯¢: buildSearchQuery(preferences) â†’ "Python å…¥é—¨"            â”‚
â”‚    â€¢ è°ƒç”¨ searchBooksTool:                                                  â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚      â”‚ å¹¶è¡Œè¯·æ±‚:                                                          â”‚  â”‚
â”‚      â”‚ â€¢ Google Books: searchGoogleBooks("Python å…¥é—¨", {language:"zh"})  â”‚  â”‚
â”‚      â”‚ â€¢ è±†ç“£: searchDoubanBooks("Python å…¥é—¨", 12)                       â”‚  â”‚
â”‚      â”‚ â€¢ Open Library: searchOpenLibrary("Python å…¥é—¨", 4)                â”‚  â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚    â€¢ åˆå¹¶å»é‡ + ç›¸å…³æ€§è¯„åˆ† + æ’åº                                           â”‚
â”‚    â€¢ LLM ç”Ÿæˆæ¨èè¯´æ˜                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. è¿”å›ç»“æœ                                                                  â”‚
â”‚    {                                                                         â”‚
â”‚      success: true,                                                          â”‚
â”‚      message: "ä¸ºæ‚¨æ‰¾åˆ° 15 æœ¬ Python å…¥é—¨ä¹¦ç±ï¼Œæ¶µç›–åŸºç¡€è¯­æ³•åˆ°å®æˆ˜é¡¹ç›®...",   â”‚
â”‚      books: [/* 20 æœ¬ä¹¦ç± */],                                              â”‚
â”‚      searchQuery: "Python å…¥é—¨",                                             â”‚
â”‚      preferences: { topic: "Python", level: "beginner", language: "zh" }    â”‚
â”‚    }                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. å‰ç«¯æ¸²æŸ“                                                                  â”‚
â”‚    â€¢ æ˜¾ç¤º AI æ¨èè¯´æ˜                                                        â”‚
â”‚    â€¢ BookCard ç½‘æ ¼å±•ç¤ºä¹¦ç±                                                   â”‚
â”‚    â€¢ PreferenceChips æ”¯æŒè°ƒæ•´åé‡æ–°æœç´¢                                      â”‚
â”‚    â€¢ ä¹¦ç±å­˜å…¥ sessionStorage ä¾›è¯¦æƒ…é¡µä½¿ç”¨                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 Basic æ¨¡å¼æ•°æ®æµ

```
ç”¨æˆ·è¾“å…¥ â†’ /api/chat (mode="basic") â†’ LLM å¯¹è¯ â†’ æ£€æµ‹ [SEARCH: xxx]
         â†’ æ‰§è¡Œæœç´¢ â†’ è¿”å›ä¹¦ç± + æ¶ˆæ¯
```

---

## 7. API è·¯ç”±

| è·¯ç”±                       | æ–¹æ³• | åŠŸèƒ½             | è¾“å…¥                         | è¾“å‡º                                       |
| -------------------------- | ---- | ---------------- | ---------------------------- | ------------------------------------------ |
| `/api/analyze-intent`      | POST | åˆ†æç”¨æˆ·æœç´¢æ„å›¾ | `{message}`                  | `{inferredPreferences, understandingText}` |
| `/api/confirm-search`      | POST | æ‰§è¡Œç¡®è®¤åçš„æœç´¢ | `{message, preferences}`     | `{message, books, searchQuery}`            |
| `/api/chat`                | POST | ç»Ÿä¸€èŠå¤©æ¥å£     | `{message, history, mode}`   | `{message, books?, state?}`                |
| `/api/search`              | POST | ç›´æ¥æœç´¢ä¹¦ç±     | `{query, filters?}`          | `{books, total, query}`                    |
| `/api/analyze`             | POST | åˆ†æå•æœ¬ä¹¦ç±     | `{book}`                     | `{analysis, book}`                         |
| `/api/recommend`           | POST | è·å–æ¨èä¹¦ç±     | `{book?, preferences?}`      | `{recommendations, basedOn}`               |
| `/api/model-config`        | GET  | è·å–å½“å‰é…ç½®     | -                            | `{provider, model}`                        |
| `/api/model-config/update` | POST | æ›´æ–°æ¨¡å‹é…ç½®     | `{provider, model, apiKey?}` | `{success}`                                |

---

## 8. ç»„ä»¶æ¶æ„

### 8.1 ç»„ä»¶å±‚æ¬¡ç»“æ„

```
App
â”œâ”€â”€ Layout (layout.tsx)
â”‚   â”œâ”€â”€ ThemeProvider
â”‚   â””â”€â”€ Toaster
â”‚
â”œâ”€â”€ HomePage (page.tsx)
â”‚   â”œâ”€â”€ Hero Section
â”‚   â”œâ”€â”€ Features Grid
â”‚   â”œâ”€â”€ How It Works
â”‚   â””â”€â”€ CTA Section
â”‚
â”œâ”€â”€ SearchPage (search/page.tsx)
â”‚   â”œâ”€â”€ Header (æ¨¡å¼åˆ‡æ¢)
â”‚   â”œâ”€â”€ Mode Selector (agent/chat/search)
â”‚   â”‚
â”‚   â”œâ”€â”€ [Agent Mode]
â”‚   â”‚   â””â”€â”€ ChatInterface (mode="agent")
â”‚   â”‚       â”œâ”€â”€ Messages List
â”‚   â”‚       â”‚   â”œâ”€â”€ UserMessage
â”‚   â”‚       â”‚   â””â”€â”€ AssistantMessage
â”‚   â”‚       â”‚       â”œâ”€â”€ PreferenceChips (æœç´¢å)
â”‚   â”‚       â”‚       â””â”€â”€ BookCard Grid (æœ‰ä¹¦ç±æ—¶)
â”‚   â”‚       â”œâ”€â”€ IntentConfirmation (å¾…ç¡®è®¤æ—¶)
â”‚   â”‚       â””â”€â”€ Input Area
â”‚   â”‚
â”‚   â”œâ”€â”€ [Chat Mode]
â”‚   â”‚   â””â”€â”€ ChatInterface (mode="basic")
â”‚   â”‚
â”‚   â””â”€â”€ [Search Mode]
â”‚       â”œâ”€â”€ SearchBox
â”‚       â””â”€â”€ BookCard Grid
â”‚
â”œâ”€â”€ BookDetailPage (book/[id]/page.tsx)
â”‚   â”œâ”€â”€ Book Cover
â”‚   â”œâ”€â”€ Book Info Card
â”‚   â”œâ”€â”€ Description
â”‚   â””â”€â”€ AIAnalysis (å¯é€‰)
â”‚
â””â”€â”€ SettingsPage (settings/page.tsx)
    â””â”€â”€ ModelSettings
        â”œâ”€â”€ Provider Selector
        â”œâ”€â”€ Model Selector
        â””â”€â”€ API Key Input
```

### 8.2 æ ¸å¿ƒç»„ä»¶è¯´æ˜

| ç»„ä»¶                 | æ–‡ä»¶                           | èŒè´£                               |
| -------------------- | ------------------------------ | ---------------------------------- |
| `ChatInterface`      | `chat/chat-interface.tsx`      | æ ¸å¿ƒèŠå¤© UIï¼Œæ”¯æŒ agent/basic æ¨¡å¼ |
| `IntentConfirmation` | `chat/intent-confirmation.tsx` | æ˜¾ç¤º AI ç†è§£ï¼Œæ”¯æŒåå¥½è°ƒæ•´         |
| `PreferenceChips`    | `chat/preference-chips.tsx`    | å¯ç‚¹å‡»çš„åå¥½æ ‡ç­¾ï¼Œæ”¯æŒè°ƒæ•´åé‡æœ   |
| `BookCard`           | `book/book-card.tsx`           | ä¹¦ç±å¡ç‰‡ï¼Œæ˜¾ç¤ºå°é¢/æ ‡é¢˜/è¯„åˆ†       |
| `AIAnalysis`         | `book/ai-analysis.tsx`         | AI åˆ†æç»“æœå±•ç¤º                    |
| `SearchBox`          | `blocks/search-box.tsx`        | æœç´¢è¾“å…¥æ¡†                         |
| `ModelSettings`      | `settings/model-settings.tsx`  | LLM é…ç½®é¢æ¿                       |

---

## 9. æ•°æ®æºé›†æˆ

### 9.1 æ•°æ®æºæ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            æ•°æ®æºæ¶æ„                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Google Books  â”‚  â”‚  Open Library â”‚  â”‚     è±†ç“£       â”‚  â”‚ IA Archive   â”‚ â”‚
â”‚  â”‚               â”‚  â”‚               â”‚  â”‚               â”‚  â”‚              â”‚ â”‚
â”‚  â”‚ â€¢ å›½é™…ä¹¦ç±    â”‚  â”‚ â€¢ å¼€æºæ•°æ®åº“   â”‚  â”‚ â€¢ ä¸­æ–‡ä¹¦ç±é¦–é€‰â”‚  â”‚ â€¢ å…¬å…±é¢†åŸŸ   â”‚ â”‚
â”‚  â”‚ â€¢ æœ€å¤§40æ¡/æ¬¡ â”‚  â”‚ â€¢ å…è´¹API     â”‚  â”‚ â€¢ è¯„åˆ†ä¿¡æ¯å¥½  â”‚  â”‚ â€¢ å¯åœ¨çº¿é˜…è¯» â”‚ â”‚
â”‚  â”‚ â€¢ éœ€API Key  â”‚  â”‚ â€¢ å°é¢/ç®€ä»‹   â”‚  â”‚ â€¢ ç§»åŠ¨ç«¯API   â”‚  â”‚ â€¢ è¶…æ—¶5ç§’    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚          â”‚                  â”‚                  â”‚                 â”‚          â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                             â”‚                  â”‚                            â”‚
â”‚                             â–¼                  â–¼                            â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚                    â”‚          searchBooksTool           â”‚                  â”‚
â”‚                    â”‚                                     â”‚                  â”‚
â”‚                    â”‚  â€¢ æ ¹æ®è¯­è¨€åå¥½åŠ¨æ€è°ƒæ•´æ¯”ä¾‹           â”‚                  â”‚
â”‚                    â”‚  â€¢ å¹¶è¡Œè¯·æ±‚æ‰€æœ‰æ•°æ®æº                â”‚                  â”‚
â”‚                    â”‚  â€¢ åˆå¹¶å»é‡                         â”‚                  â”‚
â”‚                    â”‚  â€¢ ç›¸å…³æ€§è¯„åˆ†æ’åº                   â”‚                  â”‚
â”‚                    â”‚  â€¢ è¿”å› top N ç»“æœ                  â”‚                  â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 æ•°æ®æºé…æ¯”ç­–ç•¥

```typescript
// æ ¹æ®è¯­è¨€åå¥½åŠ¨æ€è°ƒæ•´
if (language === "en") {
  googleRatio = 0.7; // è‹±æ–‡ä¼˜å…ˆ Google
  doubanRatio = 0; // ä¸æœè±†ç“£
  openLibraryRatio = 0.3;
} else if (language === "zh") {
  googleRatio = 0.4; // ä¸­æ–‡ä¼˜å…ˆè±†ç“£
  doubanRatio = 0.6; // è±†ç“£æ•°æ®æ›´å‡†ç¡®
  openLibraryRatio = 0;
} else {
  // è‡ªåŠ¨æ£€æµ‹
  googleRatio = queryHasChinese ? 0.4 : 0.6;
  doubanRatio = queryHasChinese ? 0.5 : 0.2;
  openLibraryRatio = queryHasChinese ? 0.1 : 0.2;
}
```

### 9.3 ç›¸å…³æ€§è¯„åˆ†ç®—æ³•

```typescript
function calculateRelevanceScore(book, query, keywords, languagePreference) {
  let score = 0;

  // 1. è¯­è¨€åŒ¹é…ï¼ˆç¡¬æ€§è¦æ±‚ï¼‰
  if (languagePreference === "zh" && bookLang === "en") return -1000;
  if (languagePreference === "en" && bookLang === "zh") return -1000;

  // 2. å…³é”®è¯åŒ¹é…
  for (const keyword of keywords) {
    if (title.includes(keyword)) {
      score += Math.max(30, keyword.length * 10); // æ ‡é¢˜åŒ¹é…æƒé‡é«˜
    } else if (description.includes(keyword)) {
      score += Math.max(10, keyword.length * 3); // æè¿°åŒ¹é…æƒé‡ä½
    }
  }

  // 3. åŒ¹é…è¦†ç›–ç‡åŠ æˆ
  const matchRate = (titleMatchCount + descMatchCount) / keywords.length;
  score += Math.floor(matchRate * 50);

  // 4. ä¹¦ç±è´¨é‡åˆ†
  if (book.averageRating > 0) score += Math.min(book.averageRating * 2, 10);
  if (book.ratingsCount > 100) score += Math.min(Math.log10(book.ratingsCount) * 3, 15);

  // 5. æ•°æ®æºè´¨é‡
  if (book.source === "douban" && languagePreference === "zh") score += 10;

  return score;
}
```

---

## 10. LLM å¤šæä¾›å•†æ”¯æŒ

### 10.1 æ”¯æŒçš„æä¾›å•†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         LLM æä¾›å•†æ”¯æŒ                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  å›½é™…ä¸»æµ                              å›½å†…æœåŠ¡å•†                            â”‚
â”‚  â”œâ”€â”€ OpenAI (GPT-4o, o1)              â”œâ”€â”€ Moonshot (Kimi)                   â”‚
â”‚  â”œâ”€â”€ Anthropic (Claude 3.5)           â”œâ”€â”€ æ™ºè°± AI (GLM-4)                   â”‚
â”‚  â”œâ”€â”€ Google (Gemini 2.0)              â”œâ”€â”€ ç™¾å·æ™ºèƒ½                          â”‚
â”‚  â”œâ”€â”€ DeepSeek (V3, R1)                â”œâ”€â”€ é›¶ä¸€ä¸‡ç‰© (Yi)                     â”‚
â”‚  â”œâ”€â”€ Mistral AI                       â”œâ”€â”€ MiniMax                          â”‚
â”‚  â”œâ”€â”€ Groq (è¶…å¿«æ¨ç†)                   â””â”€â”€ ç¡…åŸºæµåŠ¨ (èšåˆ)                   â”‚
â”‚  â”œâ”€â”€ Together AI                                                            â”‚
â”‚  â”œâ”€â”€ Fireworks AI                     èšåˆå¹³å°                              â”‚
â”‚  â””â”€â”€ Cohere                           â””â”€â”€ OpenRouter (200+ æ¨¡å‹)            â”‚
â”‚                                                                              â”‚
â”‚  æœ¬åœ°æ¨¡å‹                              è‡ªå®šä¹‰                                â”‚
â”‚  â””â”€â”€ Ollama                           â””â”€â”€ ä»»æ„ OpenAI å…¼å®¹æ¥å£              â”‚
â”‚      â”œâ”€â”€ llama3.2                                                           â”‚
â”‚      â”œâ”€â”€ qwen2.5                                                            â”‚
â”‚      â”œâ”€â”€ mistral                                                            â”‚
â”‚      â””â”€â”€ deepseek-r1                                                        â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.2 LLM å·¥å‚å®ç°

```typescript
// src/lib/llm/factory.ts

export function createLLM(config?: UserModelConfig): BaseChatModel {
  const cfg = config || getCurrentConfig();

  switch (cfg.provider) {
    case "ollama":
      return new ChatOllama({ model: cfg.model, baseUrl: cfg.ollamaHost });

    case "openai":
      return new ChatOpenAI({ modelName: cfg.model, apiKey: cfg.apiKey });

    case "anthropic":
      return new ChatAnthropic({ modelName: cfg.model, anthropicApiKey: cfg.apiKey });

    case "openrouter":
      return new ChatOpenAI({
        modelName: cfg.model,
        configuration: { baseURL: "https://openrouter.ai/api/v1" },
        apiKey: cfg.apiKey,
      });

    // DeepSeek, Moonshot, æ™ºè°±ç­‰ä½¿ç”¨ OpenAI å…¼å®¹æ¥å£
    case "deepseek":
    case "moonshot":
    case "zhipu":
      return new ChatOpenAI({
        modelName: cfg.model,
        configuration: { baseURL: getProviderConfig(cfg.provider)?.baseUrl },
        apiKey: cfg.apiKey,
      });

    default:
      return new ChatOllama({ model: "llama3.2:latest" }); // é»˜è®¤ Ollama
  }
}
```

### 10.3 é…ç½®ä¼˜å…ˆçº§

```
1. æœåŠ¡ç«¯ç¼“å­˜é…ç½® (é€šè¿‡ Settings é¡µé¢è®¾ç½®)
   â†“
2. ç¯å¢ƒå˜é‡é…ç½®
   â”œâ”€â”€ OPENAI_API_KEY â†’ OpenAI
   â”œâ”€â”€ ANTHROPIC_API_KEY â†’ Anthropic
   â”œâ”€â”€ DEEPSEEK_API_KEY â†’ DeepSeek
   â””â”€â”€ OPENROUTER_API_KEY â†’ OpenRouter
   â†“
3. é»˜è®¤é…ç½® â†’ Ollama (llama3.2:latest)
```

---

## 11. æ ¸å¿ƒç±»å‹å®šä¹‰

### 11.1 Book ç±»å‹

```typescript
// src/types/book.ts

export interface Book {
  id: string; // æ ¼å¼: "source_originalId"
  title: string;
  authors: string[];
  description?: string;
  publishedDate?: string;
  publisher?: string;
  pageCount?: number;
  categories?: string[];
  language?: string;
  thumbnail?: string;
  previewLink?: string;
  infoLink?: string;
  readOnlineLink?: string; // Internet Archive åœ¨çº¿é˜…è¯»
  averageRating?: number;
  ratingsCount?: number;
  isbn?: string;
  doubanRating?: number; // è±†ç“£è¯„åˆ†
  doubanUrl?: string; // è±†ç“£é“¾æ¥
  source: "google" | "openlibrary" | "internetarchive" | "douban";
}
```

### 11.2 ç”¨æˆ·åå¥½ç±»å‹

```typescript
// src/lib/agents/types.ts

export interface UserPreferences {
  topic?: string; // ä¸»é¢˜/é¢†åŸŸ
  level?: "beginner" | "intermediate" | "advanced"; // æŠ€æœ¯æ°´å¹³
  language?: "en" | "zh" | "any"; // è¯­è¨€åå¥½
  bookType?: "practical" | "theoretical" | "both"; // ä¹¦ç±ç±»å‹
  yearPreference?: "latest" | "classic" | "any"; // å‡ºç‰ˆå¹´ä»½åå¥½
}

export interface InferredPreferences {
  topic: string;
  level: "beginner" | "intermediate" | "advanced";
  levelLabel: string; // ä¸­æ–‡æ ‡ç­¾
  language: "en" | "zh" | "any";
  languageLabel: string; // ä¸­æ–‡æ ‡ç­¾
  confidence: number; // æ¨æ–­ç½®ä¿¡åº¦ 0-1
  isFiction?: boolean; // æ˜¯å¦æ˜¯æ–‡å­¦/å°è¯´ç±»
  bookType?: "practical" | "theoretical" | "both";
  bookTypeLabel?: string;
  searchKeywords?: string[]; // LLM å»ºè®®çš„æœç´¢å…³é”®è¯
}
```

### 11.3 Agent çŠ¶æ€ç±»å‹

```typescript
export type BookAgentStateType = {
  messages: BaseMessage[];
  preferences: UserPreferences;
  inferredPreferences?: InferredPreferences;
  books: Book[];
  searchQuery?: string;
  needsMoreInfo: boolean;
  missingFields: string[];
  phase: "gathering" | "searching" | "presenting" | "complete";
  error?: string;
  retryCount: number;
};
```

### 11.4 æ¨¡å‹é…ç½®ç±»å‹

```typescript
// src/types/model-config.ts

export type LLMProvider =
  | "openai"
  | "anthropic"
  | "google"
  | "deepseek"
  | "ollama"
  | "groq"
  | "together"
  | "fireworks"
  | "mistral"
  | "cohere"
  | "moonshot"
  | "zhipu"
  | "baichuan"
  | "yi"
  | "minimax"
  | "openrouter"
  | "siliconflow"
  | "custom";

export interface UserModelConfig {
  provider: LLMProvider;
  model: string;
  apiKey?: string;
  baseUrl?: string;
  ollamaHost?: string; // Ollama ç‰¹å®šé…ç½®
}
```

---

## é™„å½•: å…³é”®æ–‡ä»¶å¿«é€Ÿç´¢å¼•

| åŠŸèƒ½           | æ–‡ä»¶è·¯å¾„                                      |
| -------------- | --------------------------------------------- |
| LangGraph ä¸»å›¾ | `src/lib/agents/graph.ts`                     |
| Agent èŠ‚ç‚¹å®ç° | `src/lib/agents/nodes.ts`                     |
| æœç´¢å·¥å…·       | `src/lib/agents/tools.ts`                     |
| æç¤ºè¯æ¨¡æ¿     | `src/lib/agents/prompts.ts`                   |
| çŠ¶æ€ç±»å‹å®šä¹‰   | `src/lib/agents/types.ts`                     |
| LLM å·¥å‚       | `src/lib/llm/factory.ts`                      |
| èŠå¤©ç•Œé¢       | `src/components/chat/chat-interface.tsx`      |
| æ„å›¾ç¡®è®¤       | `src/components/chat/intent-confirmation.tsx` |
| èŠå¤© Hook      | `src/hooks/use-chat-stream.ts`                |
| æ„å›¾åˆ†æ API   | `src/app/api/analyze-intent/route.ts`         |
| ç¡®è®¤æœç´¢ API   | `src/app/api/confirm-search/route.ts`         |
| Google Books   | `src/lib/api/google-books.ts`                 |
| è±†ç“£ API       | `src/lib/api/douban.ts`                       |
| æ¨¡å‹é…ç½®ç±»å‹   | `src/types/model-config.ts`                   |

---

_æ–‡æ¡£ç”Ÿæˆæ—¶é—´: 2025-12-02_
_é€‚ç”¨ç‰ˆæœ¬: books-agents v1.0.0_
